# ラボ 2A: Azure ML Designer を使用したトレーニング パイプラインの作成

*Designer* インターフェイスは、ワークフロー、またはデータ インジェスト、変換、モデル トレーニング モジュールの*パイプライン*を定義して、機械学習モデルを作成できるドラッグ アンド ドロップ環境を提供します。その後、このパイプラインを、クライアント アプリケーションが*推論* (新しいデータから予測を生成する) に使用できる Web サービスとして公開できます。

> **注**: Azure Machine Learning Designer は、執筆時点では*プレビュー*段階にあります。予期しないエラーが発生する場合があります。

## 開始する前に

このラボを開始する前に、このラボで使用する Azure Machine Learning ワークスペースと他のリソースを作成するタスクを含む[ラボ 1A](Lab01A.md) と[ラボ 1B](Lab01B.md) を完了させてください。次に、このラボで必要となるコンピューティングを初期化するには、次の手順を実行します。

1. [Azure Machine Learning Studio の](https://ml.azure.com)「**コンピューティング**」ページの「**コンピューティング クラスター**」タブで、以前に作成したコンピューティング クラスターの名前をクリックします。
2. コンピューティング クラスターを編集して「**最小ノード数**」を 2 に変更し (ノードの最小数と最大数はいずれも 2)、「**更新**」をクリックします。これにより、クラスター ノードが常に実行され、起動するまでの待機時間が最小限に抑えられます。

    > **重要**: このラボを完了しない場合は、ノードの最小数を 0 にリセットして、不要なコストが発生しないようにしてください。

## タスク 1: Designer パイプラインの作成とデータの探索

Designer を使用するには、まずパイプラインを作成し、作業するデータセットを追加する必要があります。

1. ワークスペースの [Azure Machine Learning Studio](https://ml.azure.com) で、**デザイナー** ページを表示し、新しいパイプラインを作成します。
2. 「**設定**」ウィンドウで、既定のパイプライン名 (**Pipeline-Created-on-*日付***) を**ビジュアル糖尿病トレーニング**に変更します (**設定**ウィンドウが表示されない場合は、上部のパイプライン名の横にある **&#9881;** アイコンをクリックします)。
3. パイプラインを実行するコンピューティング先を指定する必要があることに注意してください。「**設定**」ウィンドウで、「**コンピューティング先を選択します**」をクリックし、**トレーニングクラスター**を選択して**保存**します。
4. Designer の左側で、**データセット** セクションを展開し、前の演習で作成した**糖尿病データセット** データセットをキャンバスにドラッグします。
5. キャンバス上の**糖尿病データセット**モジュールを選択します。右クリックし、**「視覚化」** メニューの **「データセット出力」** を選択します。
6. データのスキーマを確認します。さまざまな列の分布をヒストグラムとして表示できます。次に、**視覚化ウィンドウ**を閉じてから、X または **<sub>&#8599;</sub><sup>&#8601;</sup>** アイコンを使用して「設定」ウィンドウを閉じるか最小化すると、データセットと一緒にパイプライン キャンバスが表示されます。

## タスク 2: 変換の追加

モデルをトレーニングする前に、通常、データにいくつかの前処理変換を適用する必要があります。

1. 左側のウィンドウで、**「データ変換」** セクションを展開します。これには、モデルをトレーニングする前にデータを変換するために使用できる幅広いモジュールが含まれています。
2. **Normalize Data（データの正規化）**モジュールを、**diabetes dataset** モジュールの下のキャンバスにドラッグします。次に、**diabetes dataset** モジュールからの出力を**Normalize Data**モジュールの入力に接続します。
3. **Normalize Data**モジュールを選択し、その設定を表示します。変換方法と変換する列を指定する必要があります。その後、変換を **ZScore** のままにして、**列の編集**をクリックして、次の列を追加し、保存します。
    * PlasmaGlucose
    * DiastolicBloodPressure
    * TricepsThickness
    * SerumInsulin
    * BMI
    * DiabetesPedigree

    **注**: 数値列を正規化して同じスケールにし、大きい値を含む列がモデルのトレーニングに大きな影響を及ぼさないようにしています。通常、このような前処理変換の全体を適用して、トレーニング用のデータを準備しますが、この演習では簡単な作業を行います。

4. これで、トレーニングと検証のためにデータを個別のデータセットに分割する準備ができました。左側のウィンドウの「**Data Transformation**」セクションで、**Split Data**(データの分割)モジュールを**Normalize Data**モジュールの下のキャンバスにドラッグします。次に、**Normalize Data**モジュールの*変換済データセット* (左) を**Split Data**モジュールの入力に接続します。
5. **Split Data**モジュールを選択し、次のように設定します。
    * **分割モード(splitting mode)** 行の分割(Split Rows)
    * **最初の出力データセットの行の割合(Fraction of rows in the first output dataset)**: 0.7
    * **ランダム シード(Random seed)**: 123
    * **層化分割(Stratified split)**: False

## タスク 3: モデル トレーニング モジュールの追加

データを準備し、トレーニング データセットと検証データセットに分割すれば、パイプラインを構成してモデルをトレーニングおよび評価する準備が整います。

1. 左側の「**Model Training**」セクションを展開し、**Train Model(モデルのトレーニング)** モジュールを**Split Data**モジュールの下のキャンバスにドラッグします。次に、**Split Data**モジュールの*結果データセット 1(Results Dataset1)* (左) 出力を**Train Model*モジュールの*データセット(Dataset)*** (右) 入力に接続します。
2. トレーニング中のモデルは**糖尿病**の値を予測するため、**Train Model** モジュールを選択し、**Label column**を**Diabetic**に設定します (大文字と小文字とスペルを正確に一致させます)。
3. モデルが予測する**Diabetic**ラベルはバイナリ列 (糖尿病患者の場合は 1、そうでない患者の場合は 0) であるため、*分類*アルゴリズムを使用してモデルをトレーニングする必要があります。**Machine Leaning Algorithms(機械学習アルゴリズム)** セクションを展開し、**Classification(分類)** の下にある、**Two-Class Logistic Regression(2 クラスのロジスティック回帰)** モジュールをキャンバスにドラッグし、**Split Data**モジュールの左側、**Train Model** モジュールの上にドラッグします。次に、その出力を**Train Model** モジュールの**Untrained Model(未訓練モデル)** (左) 入力に接続します。
4. トレーニング済みモデルをテストするには、元のデータを分割するときに元に戻した検証データセットをスコアリングするために使用する必要があります。**Model Scoring & Evaluation(モデルのスコアリング評価)** セクションを展開し、**Train Model** モジュールの下のキャンバスに**Score Model** モジュールをドラッグします。次に、**Train Model** モジュールの出力を**Score Model** モジュールの**Trained Model(トレーニング済みモデル)** (左) 入力に接続し、**Split Data**モジュールの**Results Dataset2** (右) 出力を**Score Model** モジュールの**Dataset** (右) 入力にドラッグします。
5. モデルのパフォーマンスを評価するには、検証データセットのスコアリングによって生成されるメトリックを調べる必要があります。「**Model Scoring & Evaluation**」セクションから、**Score Model** モジュールの下のキャンバスに**Evaluate Model**モジュールをドラッグし、**Score Model** モジュールの出力を**Evaluate Model**モジュールの**Scored Dataset** (左) 入力に接続します。

## タスク 4:  トレーニング パイプラインの実行

データ フロー ステップを定義したら、トレーニング パイプラインを実行してモデルをトレーニングする準備が整います。

1. パイプラインが次のようになっていることを確認します。

    ![ビジュアル トレーニング パイプライン](images/visual-training.jpg)

2. 右上の「**送信**」をクリックします。次に、プロンプトが表示されたら、**visual-training**という名前の新しい*実験*を作成し、送信します。  これにより、コンピューティング クラスターが初期化され、パイプラインが実行されます。実行には 10 分以上かかる場合があります。デザイン キャンバスの右上で、パイプライン実行の状態を確認できます。

    **ヒント**: 実行中は、「**パイプライン**」および「**実験**」ページで、作成されたパイプラインと実験を表示できます。完了したら、「**デザイナー**」ページの**ビジュアル糖尿病トレーニング** パイプラインに切り替えます。

3. **「データの正規化」** モジュールが完了したら、このモジュールを選択し、**設定**ウィンドウの **「出力 + ログ」** タブを開き、**「変換済みデータセット」** セクションの **「データ出力」** で、**「視覚化」** アイコンをクリックします。変換された列の統計情報と分布のビジュアライゼーションを表示できます。
4. **「データの正規化」** のビジュアライゼーションを閉じ、残りのモジュールが完了するまで待ちます。次に、**モデルの評価**モジュールの出力を視覚化して、モデルのパフォーマンス メトリックを確認します。

    **注**: このモデルのパフォーマンスはそれほど優れているわけではありません。その一因としては、最小限の機能エンジニアリングと前処理のみを実行したことが考えられます。いくつかの異なる分類アルゴリズムを試して結果を比較することができます (**Split Data** モジュールの出力を複数の**Train Model(モデルのトレーニング)** モジュールと **Score Model(モデルのスコアリング)** モジュールに接続 し、2 番目にスコアリングしたモデルを**Evaluate Model**モジュールに接続して並べて比較できます)。演習のポイントは、完璧なモデルをトレーニングすることではなく、単に Designer のインターフェイスを紹介することです。
